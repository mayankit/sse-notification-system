<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SSE System - Health Dashboard</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
      padding: 40px;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #00d9ff;
    }

    .dashboard {
      max-width: 1000px;
      margin: 0 auto;
    }

    .summary {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-bottom: 30px;
      padding: 20px;
      background: #16213e;
      border-radius: 12px;
    }

    .summary-item {
      text-align: center;
    }

    .summary-label {
      font-size: 0.9em;
      color: #888;
      margin-bottom: 5px;
    }

    .summary-value {
      font-size: 1.5em;
      font-weight: bold;
    }

    .summary-value.ok { color: #00ff88; }
    .summary-value.error { color: #ff4757; }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #16213e;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 30px;
    }

    th, td {
      padding: 15px 20px;
      text-align: left;
    }

    th {
      background: #0f3460;
      font-weight: 600;
      color: #00d9ff;
    }

    tr:not(:last-child) td {
      border-bottom: 1px solid #0f3460;
    }

    .status-ok { color: #00ff88; }
    .status-degraded { color: #ffa502; }
    .status-unreachable { color: #ff4757; }

    .bar-chart {
      background: #16213e;
      border-radius: 12px;
      padding: 20px;
    }

    .bar-chart h2 {
      margin-bottom: 20px;
      color: #00d9ff;
      font-size: 1.1em;
    }

    .bar-row {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .bar-row:last-child {
      margin-bottom: 0;
    }

    .bar-label {
      width: 100px;
      font-weight: 500;
    }

    .bar-container {
      flex: 1;
      height: 24px;
      background: #0f3460;
      border-radius: 12px;
      overflow: hidden;
      margin: 0 15px;
    }

    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #00d9ff, #00ff88);
      border-radius: 12px;
      transition: width 0.3s ease;
      min-width: 2px;
    }

    .bar-value {
      width: 120px;
      text-align: right;
      font-size: 0.9em;
      color: #888;
    }

    .last-updated {
      text-align: center;
      color: #666;
      margin-top: 20px;
      font-size: 0.9em;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>Health Dashboard</h1>

  <div class="dashboard">
    <div class="summary">
      <div class="summary-item">
        <div class="summary-label">Total Connected</div>
        <div class="summary-value" id="total-connected">-</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">Redis Status</div>
        <div class="summary-value" id="redis-status">-</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">Active Nodes</div>
        <div class="summary-value" id="active-nodes">-</div>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Node</th>
          <th>Connected Users</th>
          <th>Memory (MB)</th>
          <th>Status</th>
          <th>Uptime</th>
        </tr>
      </thead>
      <tbody id="nodes-table">
        <tr>
          <td colspan="5" class="loading">Loading...</td>
        </tr>
      </tbody>
    </table>

    <div class="bar-chart">
      <h2>Connection Distribution</h2>
      <div id="bar-chart">
        <div class="loading">Loading...</div>
      </div>
    </div>

    <div class="last-updated" id="last-updated">-</div>
  </div>

  <script>
    const nodes = [
      { id: 'server_1', url: 'http://localhost:3001/health' },
      { id: 'server_2', url: 'http://localhost:3002/health' },
      { id: 'server_3', url: 'http://localhost:3003/health' }
    ];

    async function fetchNodeHealth(node) {
      try {
        const response = await fetch(node.url, {
          signal: AbortSignal.timeout(3000)
        });
        if (!response.ok) throw new Error('HTTP error');
        const data = await response.json();
        return { ...data, reachable: true };
      } catch (err) {
        return {
          serverId: node.id,
          reachable: false,
          status: 'unreachable',
          connectedUsers: 0,
          memoryMB: 0,
          uptime: 0,
          redisStatus: 'unknown'
        };
      }
    }

    async function updateDashboard() {
      const results = await Promise.all(nodes.map(fetchNodeHealth));

      let totalConnected = 0;
      let activeNodes = 0;
      let redisOk = true;

      results.forEach(r => {
        if (r.reachable) {
          totalConnected += r.connectedUsers;
          activeNodes++;
          if (r.redisStatus !== 'ok') redisOk = false;
        }
      });

      document.getElementById('total-connected').textContent = totalConnected;

      const redisEl = document.getElementById('redis-status');
      redisEl.textContent = redisOk ? 'ok' : 'error';
      redisEl.className = `summary-value ${redisOk ? 'ok' : 'error'}`;

      document.getElementById('active-nodes').textContent = `${activeNodes} / ${nodes.length}`;

      const tableHtml = results.map(r => {
        const statusClass = r.reachable
          ? (r.status === 'ok' ? 'status-ok' : 'status-degraded')
          : 'status-unreachable';
        const statusIcon = r.reachable
          ? (r.status === 'ok' ? 'ok' : 'degraded')
          : 'Unreachable';

        return `
          <tr>
            <td>${r.serverId}</td>
            <td>${r.reachable ? r.connectedUsers : '-'}</td>
            <td>${r.reachable ? r.memoryMB + ' MB' : '-'}</td>
            <td class="${statusClass}">${statusIcon}</td>
            <td>${r.reachable ? r.uptime + 's' : '-'}</td>
          </tr>
        `;
      }).join('');

      document.getElementById('nodes-table').innerHTML = tableHtml;

      const maxConnections = results[0]?.maxConnections || 50000;
      const barHtml = results.map(r => {
        const percentage = (r.connectedUsers / maxConnections) * 100;
        return `
          <div class="bar-row">
            <div class="bar-label">${r.serverId}</div>
            <div class="bar-container">
              <div class="bar-fill" style="width: ${Math.max(percentage, 0.1)}%"></div>
            </div>
            <div class="bar-value">${r.connectedUsers} / ${maxConnections}</div>
          </div>
        `;
      }).join('');

      document.getElementById('bar-chart').innerHTML = barHtml;

      const now = new Date();
      document.getElementById('last-updated').textContent =
        `Last updated: ${now.toLocaleTimeString()}`;
    }

    updateDashboard();
    setInterval(updateDashboard, 3000);
  </script>
</body>
</html>
